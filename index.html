<!DOCTYPE html>
<html>
<head>
    <title>Field Stations Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDK8ugR-SpMP3PTvr0_XTPUI8yEd0Az1RU"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            border: 2px solid red; /* Add border to visually check if map div is rendered */
        }
        .custom-map-control-button {
            background-color: #fff;
            border: 2px solid #3498db;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,.3);
            padding: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            color: black;
            font-family: Roboto, Arial, sans-serif;
            margin-right: 10px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .watermark {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 18px;
            font-family: Arial, sans-serif;
            color: rgba(0, 0, 0, 0.6);
            font-weight: bold;
            pointer-events: none;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
            position: absolute;
            top: 50%;
            left: 110%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="watermark">Â© 2024 by Vaibhav Kulkarni for Dr. Guillet</div>
    <div id="error-message" class="error-message"></div>
    <script>
        // Variables to hold map and user location marker, and to manage GPS follow feature
        let map;
        let userMarker;
        let followGPS = false;

        // Function to initialize the Google Map
        function initMap() {
            console.log("Initializing map...");

            if (navigator.geolocation) {
                console.log("Geolocation supported.");
                
                // Try to get user's current location
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        console.log("Geolocation successful:", position);
                        
                        // If successful, center the map on user's current location
                        var userCenter = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: userCenter,
                            mapTypeId: google.maps.MapTypeId.ROADMAP,
                            disableDefaultUI: true
                        });
                    },
                    function(error) {
                        console.error("Geolocation error:", error);

                        // If user denies location permission or there is an error, set a default location
                        var defaultCenter = { lat: 45.509827, lng: -75.823902 };
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 14,
                            center: defaultCenter,
                            mapTypeId: google.maps.MapTypeId.ROADMAP,
                            disableDefaultUI: true
                        });
                        // Show error message if location permission is denied
                        if (error.code === error.PERMISSION_DENIED) {
                            var errorMessage = document.getElementById('error-message');
                            errorMessage.textContent = "Location access denied. Please enable location permissions in your browser settings.";
                            errorMessage.style.display = "block";
                            setTimeout(() => {
                                errorMessage.style.display = "none";
                            }, 5000);
                        }
                    }
                );
            } else {
                console.error("Geolocation is not supported by this browser.");

                // If geolocation is not supported, set a default location
                var defaultCenter = { lat: 45.509827, lng: -75.823902 };
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 14,
                    center: defaultCenter,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    disableDefaultUI: true
                });
            }

            // Add station markers to the map
            addStationMarkers();

            // Create buttons for user interaction (Find My Location, Follow GPS)
            createButtons();
        }

        // Function to add field station markers to the map
        function addStationMarkers() {
            var stations = [
                { name: "Station 1: Parking lot", lat: 45.509827, lng: -75.823902 },
                { name: "Station 2: Bridge", lat: 45.509792, lng: -75.822759 },
                // Add more stations here...
            ];

            // Add markers for each station to the map
            stations.forEach(function(station, index) {
                console.log("Adding marker for:", station.name);

                var marker = new google.maps.Marker({
                    position: { lat: station.lat, lng: station.lng },
                    map: map,
                    title: station.name,
                    label: (index + 1).toString()
                });

                // Add information window for each marker
                var infowindow = new google.maps.InfoWindow({
                    content: '<div><strong>' + station.name + '</strong><br>Flora and Fauna to Observe: Example details here</div>'
                });

                // Open information window when marker is clicked
                marker.addListener('click', function() {
                    infowindow.open(map, marker);
                });
            });
        }

        // Function to create user interaction buttons (Find My Location, Follow GPS)
        function createButtons() {
            var buttonContainer = document.createElement("div");
            buttonContainer.classList.add("button-container");

            // Button to find user's current location
            var locationButton = document.createElement("button");
            locationButton.textContent = "Find My Location";
            locationButton.classList.add("custom-map-control-button");
            buttonContainer.appendChild(locationButton);

            // Loading spinner to indicate when location is being fetched
            var loadingSpinner = document.createElement("div");
            loadingSpinner.classList.add("loading-spinner");
            loadingSpinner.style.display = "none";
            locationButton.appendChild(loadingSpinner); // Attach loading spinner to location button

            // Button to enable/disable GPS follow mode
            var followButton = document.createElement("button");
            followButton.textContent = "Enable Follow GPS";
            followButton.classList.add("custom-map-control-button");
            buttonContainer.appendChild(followButton);

            // Add button container to the map controls
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(buttonContainer);

            // Event listener for location button
            locationButton.addEventListener("click", function() {
                loadingSpinner.style.display = "block";
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            loadingSpinner.style.display = "none";
                            console.log("Finding user location:", position);
                            
                            var userPos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // Update or add user marker on the map
                            if (userMarker) {
                                userMarker.setMap(null);
                            }

                            userMarker = new google.maps.Marker({
                                position: userPos,
                                map: map,
                                title: "You are here",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: "#00F",
                                    fillOpacity: 0.8,
                                    strokeWeight: 2,
                                    strokeColor: "#FFF"
                                }
                            });

                            // Center map on user's position if follow GPS is enabled
                            if (followGPS) {
                                map.setCenter(userPos);
                            }
                        },
                        function(error) {
                            console.error("Geolocation error:", error);
                            loadingSpinner.style.display = "none";
                            var errorMessage = document.getElementById('error-message');
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage.textContent = "Location access denied. Please enable location permissions in your browser settings.";
                            } else {
                                errorMessage.textContent = "Geolocation failed or is not available.";
                            }
                            errorMessage.style.display = "block";
                            setTimeout(() => {
                                errorMessage.style.display = "none";
                            }, 5000);
                        },
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
                    );
                } else {
                    console.error("Geolocation not supported.");
                    loadingSpinner.style.display = "none";
                    var errorMessage = document.getElementById('error-message');
                    errorMessage.textContent = "Geolocation is not supported by this browser.";
                    errorMessage.style.display = "block";
                    setTimeout(() => {
                        errorMessage.style.display = "none";
                    }, 5000);
                }
            });

            // Event listener for follow GPS button
            followButton.addEventListener("click", function() {
                followGPS = !followGPS;
                followButton.textContent = followGPS ? "Disable Follow GPS" : "Enable Follow GPS";
                followButton.style.backgroundColor = followGPS ? "#4CAF50" : "#fff";
                followButton.style.color = followGPS ? "white" : "black";
            });
        }

        // Initialize map when window loads
        window.onload = initMap;
    </script>
</body>
</html>
